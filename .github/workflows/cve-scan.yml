name: CVE scan containers
on:
  push:
    branches:
    - tests
  pull_request:
    branches:
    - tests
  workflow_dispatch:
permissions:
  contents: read
  security-events: write
jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Load image tags from .env
      run: |
        set -e
        echo "SERVER_HUB_TAG=$(sed -n 's/^SITESPEED_IO_SERVER_VERSION=//p' .env | tr -d '\"')" >> $GITHUB_ENV
        echo "TESTRUNNER_HUB_TAG=$(sed -n 's/^SITESPEED_IO_TESTRUNNER_VERSION=//p' .env | tr -d '\"')" >> $GITHUB_ENV
        echo "KEYDB_TAG=$(sed -n 's/^KEYDB_DOCKER_VERSION=//p' .env | tr -d '\"')" >> $GITHUB_ENV
        echo "POSTGRES_TAG=$(sed -n 's/^POSTGRESQL_DOCKER_VERSION=//p' .env | tr -d '\"')" >> $GITHUB_ENV
        echo "MINIO_TAG=$(sed -n 's/^MINIO_DOCKER_VERSION=//p' .env | tr -d '\"')" >> $GITHUB_ENV
        echo "MINIO_MC_TAG=$(sed -n 's/^MINIO_MC_DOCKER_VERSION=//p' .env | tr -d '\"')" >> $GITHUB_ENV
        echo "SITESPEED_IO_CONTAINER=$(sed -n 's/^SITESPEED_IO_CONTAINER=//p' .env | tr -d '\"')" >> $GITHUB_ENV
    - name: Build local server image
      run: docker build --tag sitespeedio/server:local-cve -f ./server/Dockerfile server
    - name: Build local testrunner image
      run: docker build --tag sitespeedio/testrunner:local-cve -f ./testrunner/Dockerfile testrunner
    - name: Pull dependency images
      run: |
        docker pull eqalpha/keydb:${{ env.KEYDB_TAG }}
        docker pull postgres:${{ env.POSTGRES_TAG }}
        docker pull minio/minio:${{ env.MINIO_TAG }}
        docker pull minio/mc:${{ env.MINIO_MC_TAG }}
        docker pull ${{ env.SITESPEED_IO_CONTAINER }}
        docker pull sitespeedio/server:${{ env.SERVER_HUB_TAG }}
        docker pull sitespeedio/testrunner:${{ env.TESTRUNNER_HUB_TAG }}
    - name: Trivy scan local server image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: sitespeedio/server:local-cve
        format: sarif
        output: trivy-local-server.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (local server)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-local-server.sarif
        category: trivy-local-server
    - name: Trivy scan local testrunner image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: sitespeedio/testrunner:local-cve
        format: sarif
        output: trivy-local-testrunner.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (local testrunner)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-local-testrunner.sarif
        category: trivy-local-testrunner
    - name: Trivy scan Docker Hub server image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: sitespeedio/server:${{ env.SERVER_HUB_TAG }}
        format: sarif
        output: trivy-hub-server.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (hub server)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-hub-server.sarif
        category: trivy-hub-server
    - name: Trivy scan Docker Hub testrunner image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: sitespeedio/testrunner:${{ env.TESTRUNNER_HUB_TAG }}
        format: sarif
        output: trivy-hub-testrunner.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (hub testrunner)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-hub-testrunner.sarif
        category: trivy-hub-testrunner
    - name: Trivy scan dependency keydb image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: eqalpha/keydb:${{ env.KEYDB_TAG }}
        format: sarif
        output: trivy-dep-keydb.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (dependency keydb)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-dep-keydb.sarif
        category: trivy-dep-keydb
    - name: Trivy scan dependency postgres image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: postgres:${{ env.POSTGRES_TAG }}
        format: sarif
        output: trivy-dep-postgres.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (dependency postgres)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-dep-postgres.sarif
        category: trivy-dep-postgres
    - name: Trivy scan dependency minio image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: minio/minio:${{ env.MINIO_TAG }}
        format: sarif
        output: trivy-dep-minio.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (dependency minio)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-dep-minio.sarif
        category: trivy-dep-minio
    - name: Trivy scan dependency minio-mc image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: minio/mc:${{ env.MINIO_MC_TAG }}
        format: sarif
        output: trivy-dep-minio-mc.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (dependency minio-mc)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-dep-minio-mc.sarif
        category: trivy-dep-minio-mc
    - name: Trivy scan dependency sitespeed.io image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: ${{ env.SITESPEED_IO_CONTAINER }}
        format: sarif
        output: trivy-dep-sitespeedio.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (dependency sitespeed.io)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-dep-sitespeedio.sarif
        category: trivy-dep-sitespeedio
    - name: Trivy gate local server image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: sitespeedio/server:local-cve
        severity: CRITICAL
        exit-code: 1
        format: table
    - name: Trivy gate local testrunner image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: sitespeedio/testrunner:local-cve
        severity: CRITICAL
        exit-code: 1
        format: table
    - name: Trivy gate Docker Hub server image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: sitespeedio/server:${{ env.SERVER_HUB_TAG }}
        severity: CRITICAL
        exit-code: 1
        format: table
    - name: Trivy gate Docker Hub testrunner image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: sitespeedio/testrunner:${{ env.TESTRUNNER_HUB_TAG }}
        severity: CRITICAL
        exit-code: 1
        format: table
    - name: Trivy gate dependency keydb image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: eqalpha/keydb:${{ env.KEYDB_TAG }}
        severity: CRITICAL
        exit-code: 1
        format: table
    - name: Trivy gate dependency postgres image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: postgres:${{ env.POSTGRES_TAG }}
        severity: CRITICAL
        exit-code: 1
        format: table
    - name: Trivy gate dependency minio image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: minio/minio:${{ env.MINIO_TAG }}
        severity: CRITICAL
        exit-code: 1
        format: table
    - name: Trivy gate dependency minio-mc image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: minio/mc:${{ env.MINIO_MC_TAG }}
        severity: CRITICAL
        exit-code: 1
        format: table
    - name: Trivy gate dependency sitespeed.io image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: ${{ env.SITESPEED_IO_CONTAINER }}
        severity: CRITICAL
        exit-code: 1
        format: table
