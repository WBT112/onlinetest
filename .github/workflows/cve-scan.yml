name: CVE scan containers
on:
  push:
    branches:
    - tests
    paths-ignore:
    - reports/cve-latest.md
  pull_request:
    branches:
    - tests
  workflow_dispatch:
permissions:
  contents: write
  security-events: write
jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Load image tags from .env
      run: |
        set -e
        echo "SERVER_HUB_TAG=$(sed -n 's/^SITESPEED_IO_SERVER_VERSION=//p' .env | tr -d '\"')" >> $GITHUB_ENV
        echo "TESTRUNNER_HUB_TAG=$(sed -n 's/^SITESPEED_IO_TESTRUNNER_VERSION=//p' .env | tr -d '\"')" >> $GITHUB_ENV
        echo "KEYDB_TAG=$(sed -n 's/^KEYDB_DOCKER_VERSION=//p' .env | tr -d '\"')" >> $GITHUB_ENV
        echo "POSTGRES_TAG=$(sed -n 's/^POSTGRESQL_DOCKER_VERSION=//p' .env | tr -d '\"')" >> $GITHUB_ENV
        echo "MINIO_TAG=$(sed -n 's/^MINIO_DOCKER_VERSION=//p' .env | tr -d '\"')" >> $GITHUB_ENV
        echo "MINIO_MC_TAG=$(sed -n 's/^MINIO_MC_DOCKER_VERSION=//p' .env | tr -d '\"')" >> $GITHUB_ENV
        echo "SITESPEED_IO_CONTAINER=$(sed -n 's/^SITESPEED_IO_CONTAINER=//p' .env | tr -d '\"')" >> $GITHUB_ENV
    - name: Build local server image
      run: docker build --tag sitespeedio/server:local-cve -f ./server/Dockerfile server
    - name: Build local testrunner image
      run: docker build --tag sitespeedio/testrunner:local-cve -f ./testrunner/Dockerfile testrunner
    - name: Pull dependency images
      run: |
        docker pull eqalpha/keydb:${{ env.KEYDB_TAG }}
        docker pull postgres:${{ env.POSTGRES_TAG }}
        docker pull minio/minio:${{ env.MINIO_TAG }}
        docker pull minio/mc:${{ env.MINIO_MC_TAG }}
        docker pull ${{ env.SITESPEED_IO_CONTAINER }}
        docker pull sitespeedio/server:${{ env.SERVER_HUB_TAG }}
        docker pull sitespeedio/testrunner:${{ env.TESTRUNNER_HUB_TAG }}
    - name: Trivy scan local server image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: sitespeedio/server:local-cve
        format: sarif
        output: trivy-local-server.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (local server)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-local-server.sarif
        category: trivy-local-server
    - name: Trivy scan local testrunner image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: sitespeedio/testrunner:local-cve
        format: sarif
        output: trivy-local-testrunner.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (local testrunner)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-local-testrunner.sarif
        category: trivy-local-testrunner
    - name: Trivy scan Docker Hub server image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: sitespeedio/server:${{ env.SERVER_HUB_TAG }}
        format: sarif
        output: trivy-hub-server.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (hub server)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-hub-server.sarif
        category: trivy-hub-server
    - name: Trivy scan Docker Hub testrunner image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: sitespeedio/testrunner:${{ env.TESTRUNNER_HUB_TAG }}
        format: sarif
        output: trivy-hub-testrunner.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (hub testrunner)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-hub-testrunner.sarif
        category: trivy-hub-testrunner
    - name: Trivy scan dependency keydb image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: eqalpha/keydb:${{ env.KEYDB_TAG }}
        format: sarif
        output: trivy-dep-keydb.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (dependency keydb)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-dep-keydb.sarif
        category: trivy-dep-keydb
    - name: Trivy scan dependency postgres image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: postgres:${{ env.POSTGRES_TAG }}
        format: sarif
        output: trivy-dep-postgres.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (dependency postgres)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-dep-postgres.sarif
        category: trivy-dep-postgres
    - name: Trivy scan dependency minio image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: minio/minio:${{ env.MINIO_TAG }}
        format: sarif
        output: trivy-dep-minio.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (dependency minio)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-dep-minio.sarif
        category: trivy-dep-minio
    - name: Trivy scan dependency minio-mc image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: minio/mc:${{ env.MINIO_MC_TAG }}
        format: sarif
        output: trivy-dep-minio-mc.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (dependency minio-mc)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-dep-minio-mc.sarif
        category: trivy-dep-minio-mc
    - name: Trivy scan dependency sitespeed.io image (SARIF)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: ${{ env.SITESPEED_IO_CONTAINER }}
        format: sarif
        output: trivy-dep-sitespeedio.sarif
        severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
        exit-code: 0
    - name: Upload Trivy SARIF (dependency sitespeed.io)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-dep-sitespeedio.sarif
        category: trivy-dep-sitespeedio
    - name: Generate CVE report
      run: |
        node - <<'NODE'
        const fs = require('fs');
        const now = new Date().toISOString();
        const sha = process.env.GITHUB_SHA || 'unknown';
        const serverUrl = process.env.GITHUB_SERVER_URL || 'https://github.com';
        const repo = process.env.GITHUB_REPOSITORY || '';
        const runId = process.env.GITHUB_RUN_ID || '';
        const runUrl = repo && runId ? `${serverUrl}/${repo}/actions/runs/${runId}` : '';
        const env = process.env;
        const images = [
          { label: 'sitespeedio/server:local-cve', file: 'trivy-local-server.sarif' },
          { label: 'sitespeedio/testrunner:local-cve', file: 'trivy-local-testrunner.sarif' },
          { label: `sitespeedio/server:${env.SERVER_HUB_TAG || 'unknown'}`, file: 'trivy-hub-server.sarif' },
          { label: `sitespeedio/testrunner:${env.TESTRUNNER_HUB_TAG || 'unknown'}`, file: 'trivy-hub-testrunner.sarif' },
          { label: `eqalpha/keydb:${env.KEYDB_TAG || 'unknown'}`, file: 'trivy-dep-keydb.sarif' },
          { label: `postgres:${env.POSTGRES_TAG || 'unknown'}`, file: 'trivy-dep-postgres.sarif' },
          { label: `minio/minio:${env.MINIO_TAG || 'unknown'}`, file: 'trivy-dep-minio.sarif' },
          { label: `minio/mc:${env.MINIO_MC_TAG || 'unknown'}`, file: 'trivy-dep-minio-mc.sarif' },
          { label: env.SITESPEED_IO_CONTAINER || 'sitespeedio/sitespeed.io:unknown', file: 'trivy-dep-sitespeedio.sarif' }
        ];
        function normalizeSeverity(value) {
          if (value === undefined || value === null) {
            return null;
          }
          const text = String(value);
          if (/^[0-9.]+$/.test(text)) {
            const num = Number(text);
            if (num >= 9) return 'CRITICAL';
            if (num >= 7) return 'HIGH';
            if (num >= 4) return 'MEDIUM';
            if (num >= 1) return 'LOW';
            return 'UNKNOWN';
          }
          const sev = text.toUpperCase();
          if (['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'UNKNOWN'].includes(sev)) {
            return sev;
          }
          return 'UNKNOWN';
        }
        function severityFromRule(rule) {
          if (!rule || !rule.properties) return null;
          return (
            normalizeSeverity(rule.properties.severity) ||
            normalizeSeverity(rule.properties.Severity) ||
            normalizeSeverity(rule.properties['security-severity'])
          );
        }
        function severityFromResult(result, ruleSeverityById) {
          if (result && result.properties) {
            const direct =
              normalizeSeverity(result.properties.severity) ||
              normalizeSeverity(result.properties.Severity) ||
              normalizeSeverity(result.properties['security-severity']);
            if (direct) return direct;
          }
          if (result && result.ruleId && ruleSeverityById.has(result.ruleId)) {
            return ruleSeverityById.get(result.ruleId);
          }
          return null;
        }
        function countSeverities(file) {
          const counts = { CRITICAL: 0, HIGH: 0, MEDIUM: 0, LOW: 0, UNKNOWN: 0 };
          const data = JSON.parse(fs.readFileSync(file, 'utf8'));
          for (const run of data.runs || []) {
            const ruleSeverityById = new Map();
            const rules = run.tool && run.tool.driver && run.tool.driver.rules ? run.tool.driver.rules : [];
            for (const rule of rules) {
              const sev = severityFromRule(rule);
              if (sev && rule.id) {
                ruleSeverityById.set(rule.id, sev);
              }
            }
            for (const result of run.results || []) {
              const sev = severityFromResult(result, ruleSeverityById) || 'UNKNOWN';
              counts[sev] = (counts[sev] || 0) + 1;
            }
          }
          return counts;
        }
        const lines = [];
        lines.push('# Container CVE Report');
        lines.push('');
        lines.push(`Generated: ${now}`);
        lines.push(`Commit: ${sha}`);
        if (runUrl) {
          lines.push(`Run: ${runUrl}`);
        }
        lines.push('');
        lines.push('Trivy findings by image. See the Security -> Code scanning alerts for details.');
        lines.push('');
        lines.push('| Image | Critical | High | Medium | Low | Unknown |');
        lines.push('|---|---:|---:|---:|---:|---:|');
        for (const item of images) {
          const counts = countSeverities(item.file);
          lines.push(`| ${item.label} | ${counts.CRITICAL || 0} | ${counts.HIGH || 0} | ${counts.MEDIUM || 0} | ${counts.LOW || 0} | ${counts.UNKNOWN || 0} |`);
        }
        fs.mkdirSync('reports', { recursive: true });
        fs.writeFileSync('reports/cve-latest.md', lines.join('\n') + '\n');
        NODE
    - name: Commit CVE report
      if: github.event_name != 'pull_request'
      run: |
        if [ -n "$(git status --porcelain reports/cve-latest.md)" ]; then
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add reports/cve-latest.md
          git commit -m "Update CVE report"
          git push
        else
          echo "No report changes"
        fi
    - name: Trivy report local server image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: sitespeedio/server:local-cve
        severity: CRITICAL
        exit-code: 0
        format: table
    - name: Trivy report local testrunner image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: sitespeedio/testrunner:local-cve
        severity: CRITICAL
        exit-code: 0
        format: table
    - name: Trivy report Docker Hub server image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: sitespeedio/server:${{ env.SERVER_HUB_TAG }}
        severity: CRITICAL
        exit-code: 0
        format: table
    - name: Trivy report Docker Hub testrunner image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: sitespeedio/testrunner:${{ env.TESTRUNNER_HUB_TAG }}
        severity: CRITICAL
        exit-code: 0
        format: table
    - name: Trivy report dependency keydb image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: eqalpha/keydb:${{ env.KEYDB_TAG }}
        severity: CRITICAL
        exit-code: 0
        format: table
    - name: Trivy report dependency postgres image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: postgres:${{ env.POSTGRES_TAG }}
        severity: CRITICAL
        exit-code: 0
        format: table
    - name: Trivy report dependency minio image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: minio/minio:${{ env.MINIO_TAG }}
        severity: CRITICAL
        exit-code: 0
        format: table
    - name: Trivy report dependency minio-mc image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: minio/mc:${{ env.MINIO_MC_TAG }}
        severity: CRITICAL
        exit-code: 0
        format: table
    - name: Trivy report dependency sitespeed.io image (critical)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: ${{ env.SITESPEED_IO_CONTAINER }}
        severity: CRITICAL
        exit-code: 0
        format: table
