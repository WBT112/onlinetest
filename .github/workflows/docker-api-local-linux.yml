name: API test running everything in Docker using Linux
on:
  push:
    branches:
    - main
    - tests
  pull_request:
    branches:
    - main
    - tests
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24.x'
    - uses: actions/checkout@v4
    - name: Build server
      run: docker build --load --tag sitespeedio/server:local-action -f ./server/Dockerfile server
    - name: Build testrunner
      run: docker build --load  --tag sitespeedio/testrunner:local-action -f ./testrunner/Dockerfile testrunner
    - name: Start dependencies
      env:
        SITESPEED_IO_SERVER_VERSION: "local-action"
        SITESPEED_IO_TESTRUNNER_VERSION: "local-action"
      run: docker compose -f docker-compose.yml -f docker-compose.app.yml up -d
    - name: API validation checks
      run: |
        set -e
        curl_opts="--retry 15 --retry-all-errors --retry-delay 2 --connect-timeout 2 --max-time 10"
        for i in {1..30}; do
          if curl $curl_opts -s -o /dev/null http://127.0.0.1:3000/api; then
            ready=1
            break
          fi
          sleep 2
        done
        [ "${ready:-0}" -eq 1 ]
        missing_status=$(curl $curl_opts -s -o /dev/null -w "%{http_code}" -H "Content-Type: application/json" -X POST http://127.0.0.1:3000/api/add -d '{"_":["https://www.wikipedia.org"],"api":{"testType":"desktop"}}')
        [ "$missing_status" -eq 400 ]
        invalid_status=$(curl $curl_opts -s -o /dev/null -w "%{http_code}" -H "Content-Type: application/json" -X POST http://127.0.0.1:3000/api/add -d '{"_":["notaurl"],"api":{"location":"default","testType":"desktop"}}')
        [ "$invalid_status" -eq 400 ]
    - name: Show versions
      run: |
        docker --version
        docker ps
        docker network ls
        docker network inspect skynet
    - name: Wait for test runner registration
      run: |
        for i in {1..20}; do
          count=$(curl -s http://127.0.0.1:3000/api/testRunners | node -e "const fs=require('fs'); const data=JSON.parse(fs.readFileSync(0,'utf8')); process.stdout.write(String(Array.isArray(data) ? data.length : 0));")
          if [ "$count" -gt 0 ]; then
            exit 0
          fi
          sleep 3
        done
        echo "No test runner registered"
        exit 1
    - name: Get host IP
      run: echo "HOST_IP=$(hostname -I | awk '{print $1}')" >> $GITHUB_ENV
    - name: Run a test
      run: |
        git clone https://github.com/sitespeedio/sitespeed.io.git
        cd sitespeed.io
        npm install
        bin/sitespeed.js https://www.wikipedia.org -n 1 --api.hostname 127.0.0.1  --api.location default --headless --api.json --s3.endpoint "http://${{ env.HOST_IP }}:9000" 2>&1 | tee ../api-response.log
    - name: Extract test id
      run: |
        for i in {1..30}; do
          TEST_ID=$(docker logs onlinetest-sitespeed.io-server-1 2>&1 | node -e "const fs=require('fs'); const data=fs.readFileSync(0,'utf8'); const matches=[...data.matchAll(/Adding test with id ([0-9a-f-]{36})/gi)]; if(matches.length){process.stdout.write(matches[matches.length-1][1]);}")
          if [ -n "$TEST_ID" ]; then
            echo "TEST_ID=$TEST_ID" >> $GITHUB_ENV
            exit 0
          fi
          sleep 2
        done
        echo "No test id found in docker logs"
        exit 1
    - name: Wait for test completion
      run: |
        for i in {1..60}; do
          status_json=$(curl -s http://127.0.0.1:3000/api/status/${TEST_ID})
          status=$(echo "$status_json" | node -e "const fs=require('fs'); const data=JSON.parse(fs.readFileSync(0,'utf8')); process.stdout.write(data.status || '');")
          echo "status=$status"
          if [ "$status" = "completed" ]; then
            result=$(echo "$status_json" | node -e "const fs=require('fs'); const data=JSON.parse(fs.readFileSync(0,'utf8')); process.stdout.write(data.result || '');")
            echo "RESULT_URL=$result" >> $GITHUB_ENV
            exit 0
          fi
          if [ "$status" = "failed" ]; then
            echo "$status_json"
            exit 1
          fi
          sleep 10
        done
        echo "Timed out waiting for test completion"
        exit 1
    - name: Verify result URL is reachable
      run: |
        if [ -z "$RESULT_URL" ]; then
          echo "Missing RESULT_URL"
          exit 1
        fi
        curl -f -I "$RESULT_URL"
    - name: Verify HAR is available
      run: |
        curl -s -f http://127.0.0.1:3000/api/har/${TEST_ID} > har.json
        node -e "const fs=require('fs'); const har=JSON.parse(fs.readFileSync('har.json','utf8')); if(!har.log || !Array.isArray(har.log.entries)) { throw new Error('Invalid HAR'); }"
    - name: Display Server log
      if: failure() || success()
      run: docker logs onlinetest-sitespeed.io-server-1
    - name: Display testrunner log
      if: failure() || success()
      run: docker logs onlinetest-sitespeed.io-testrunner-1
